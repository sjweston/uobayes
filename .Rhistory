PA.std ~ 1 + day*female + (1 + day | id),
prior = c( prior(normal(0, 1), class=Intercept),
prior(normal(0, 1), class=b),
prior(exponential(1), class=sd),
prior(exponential(1), class=sigma)),
iter=5000, warmup=1000, chains=4, cores=4, seed=9,
file=here("files/models/m71.5")
)
m5
data_path = "https://raw.githubusercontent.com/sjweston/uobayes/refs/heads/main/files/data/external_data/williams.csv"
d <- read.csv(data_path)
d
d %>% count(id)
d %>% count(id) %>% select(n) %>% rethinking::precis()
mean(d$PA.std)
m2
m2 <- brm(
data=d,
family=gaussian,
PA.std ~ 1 + (1 | id),
prior = c( prior(normal(0, 1.5), class=Intercept),
prior(exponential(1), class=sd),
prior(exponential(1), class=sigma)),
iter=4000, warmup=1000, chains=4, cores=4, seed=9, #running this longer so it mixes
control = list(adapt_delta =.99),
file=here("files/models/m71.2")
)
m2
get_variables(m2)
loo_compare(m1, m2) %>% print(simplify=F)
m2 <- add_criterion(m2, criterion = "loo")
loo_compare(m1, m2) %>% print(simplify=F)
m1
m2
m2 %>% gather_draws(b_Intercept, r_id[id, Intercept])
m2 %>% spread_draws(b_Intercept, r_id[id, Intercept])
m2 %>% spread_draws(b_Intercept, r_id[id, Intercept]) %>% head()
m2 %>% spread_draws(b_Intercept, r_id[id, Intercept]) %>%
mutate(PA = b_Intercept + r_id)
m2 %>% spread_draws(b_Intercept, r_id[id, Intercept]) %>%
mutate(PA = b_Intercept + r_id) %>%
head()
nd = distinct(d, id)
add_epred_draws(m2, nd)
nd = distinct(d, id)
nd
add_epred_draws(m2, nd)
add_epred_draws(nd, m2)
m2 %>% spread_draws(b_Intercept, r_id[id, Intercept]) %>%
mutate(PA = b_Intercept + r_id) %>%
head()
m2 %>%
spread_draws(sd_id__Intercept, sigma)
sd(d$PA.std)
sd(d$PA.std)^2
# original sd and variance
c("sd" = sd(d$PA.std), "var" = sd(d$PA.std)^2) %>% round(3)
# model estimates of sd between and within
m2 %>%
spread_draws(sd_id__Intercept, sigma) %>% head()
m2 %>%
spread_draws(sd_id__Intercept, sigma) %>%
mutate( across( starts_with("s"), ~.^2 ) )
m2 %>%
spread_draws(sd_id__Intercept, sigma) %>%
mutate( across( starts_with("s"), ~.^2 ) ,
total = sd_id__Intercept + sigma)
# original sd and variance
c("sd" = sd(d$PA.std), "var" = sd(d$PA.std)^2) %>% round(3)
# model estimates of sd between and within
m2 %>%
spread_draws(sd_id__Intercept, sigma)
m2 %>%
spread_draws(sd_id__Intercept, sigma) %>%
mutate( across( starts_with("s"), ~.^2 ) ,
total = sd_id__Intercept + sigma)
m2 %>%
spread_draws(sd_id__Intercept, sigma) %>%
mutate( across( starts_with("s"), ~.^2 ) ,
total = sd_id__Intercept + sigma) %>% head()
# original sd and variance
c("sd" = sd(d$PA.std), "var" = sd(d$PA.std)^2) %>% round(3)
m2 %>% spread_draws(sd_id__Intercept, sigma) %>%
rename(
between = sd_id__Intercept,
within = sigma
)
m2 %>% spread_draws(sd_id__Intercept, sigma) %>%
rename(
between = sd_id__Intercept,
within = sigma
) %>%
ggplot( aes(x=between, y=within) ) +
geom_point(alpha=.7)
m2 %>% spread_draws(sd_id__Intercept, sigma) %>%
rename(
between = sd_id__Intercept,
within = sigma
) %>%
mutate(across(c(between,within), ~.^2)) %>%
ggplot( aes(x=between, y=within) ) +
geom_point(alpha=.7)
library(here)
d <- read_csv(here("files/data/external_data/yllanon.csv"))
# Chunk 1
library(tidyverse)
library(psych)
library(cowplot)
library(patchwork)
library(here)
library(brms)
library(tidybayes)
# Chunk 2
knitr::opts_chunk$set(fig.retina=3, echo=TRUE)
theme_set(theme_cowplot())
default_palettes <- list(
c("#5e8485" , "#0f393a") ,
c("#1c5253" , "#5e8485" , "#0f393a") ,
# palette with 5 colours
c( "#1c5253" , "#e07a5f", "#f2cc8f" , "#81b29a" , "#3d405b" ) ,
# same palette interpolated to 8 colours
c( "#1c5253" , "#e07a5f", "#f2cc8f" , "#81b29a" , "#3d405b" , "#a7a844" , "#69306d" )
)
options(ggplot2.discrete.fill = default_palettes,
ggplot2.discrete.colour = default_palettes)
d <- read_csv(here("files/data/external_data/yllanon.csv"))
rethinking::precis(d)
names(d)
d %>%
ggplot(aes(x=wave, y = imm)) +
geom_smooth()
d %>%
ggplot(aes(x=wave, y = crime)) +
geom_smooth()
d %>%
ggplot(aes(x=wave, y = vaccines)) +
geom_smooth()
d %>%
ggplot(aes(x=age, y = vaccines)) +
geom_smooth()
d %>%
ggplot( aes(x=age, y = vaccines))
d %>%
ggplot( aes(x=age, y = vaccines)) +
geom_smooth()
d %>%
filter(wave == 1) %>%
ggplot( aes(x=age, y = vaccines)) +
geom_smooth()
d1 = d %>% filter(wave == 1)
?dist
dist(d1$age)
test = dist(d1$age)
dim(test)
str(test)
552*552
test
d_matrix = matrix(nrow = nrow(d1), ncol=nrow(d1))
View(d_matrix)
d_matrix[upper(d_matrix)] = distances
d1 = d %>% filter(wave == 1)
distances = dist(d1$age)
d_matrix = matrix(nrow = nrow(d1), ncol=nrow(d1))
d_matrix[upper(d_matrix)] = distances
d_matrix[upper.tri(d_matrix)] = distances
d_matrix[lower.tri(d_matrix)] = distances
View(d_matrix)
d1$age %>% head()
#create empty matrix and fill it
d_matrix = matrix(nrow = nrow(d1), ncol=nrow(d1))
d_matrix[upper.tri(d_matrix)] = d_matrix[lower.tri(d_matrix)] = distances
d_matrix[diag(d_matrix)] = 0
View(d_matrix)
diag(d_matrix)
#create empty matrix and fill it
d_matrix = matrix(data = 0, nrow = nrow(d1), ncol=nrow(d1))
d_matrix[upper.tri(d_matrix)] = d_matrix[lower.tri(d_matrix)] = distances
d1 = d1 %>%
mutate(vaccines = ifelse( vaccines > 7, NA, vaccines))
m1 <- brm(
data = d1,
family = cumulative,
vaccines ~ 1,
prior = list( prior(normal(0,1), class=Intercept)),
iter=2000, warmup=1000, seed=3, cores=4
)
library(tidyverse)
library(psych)
library(cowplot)
library(patchwork)
library(here)
library(brms)
library(tidybayes)
d1 = d1 %>%
mutate(vaccines = ifelse( vaccines > 7, NA, vaccines))
m1 <- brm(
data = d1,
family = cumulative,
vaccines ~ 1,
prior = list( prior(normal(0,1), class=Intercept)),
iter=2000, warmup=1000, seed=3, cores=4
)
d1 = d1 %>%
mutate(vaccines = ifelse( vaccines > 7, NA, vaccines))
m1 <- brm(
data = d1,
family = cumulative,
vaccines ~ 1,
prior = c( prior(normal(0,1), class=Intercept)),
iter=2000, warmup=1000, seed=3, cores=4
)
m1
m1 <- brm(
data = d1,
family = cumulative,
bf( vaccines ~ a,
a ~ 1 + gp(age, scale = F),
nl = TRUE),
prior = c( prior(normal(0,1), class=a),
prior(inv_gamma(3, 3), class=lscale, coef=gpage, nlpar=a)),
iter=2000, warmup=1000, seed=3, cores=4
)
m1 <- brm(
data = d1,
family = cumulative,
bf( vaccines ~ a,
a ~ 1 + gp(age, scale = F),
nl = TRUE),
prior = c(
#prior(normal(0,1), class=a),
prior(inv_gamma(3, 3), class=lscale, coef=gpage, nlpar=a)),
iter=2000, warmup=1000, seed=3, cores=4
)
m1
post <-
as_draws_df(m1) %>%
mutate(etasq = sdgp_a_gpage^2)
post <-
post %>%
mutate(rhosq = 1 / (2 * lscale_a_gpage^2))
post %>%
slice_sample(n = 50) %>%
expand_grid(x = seq(from = 0, to = 10, by = .05)) %>%
mutate(covariance = etasq * exp(-rhosq * x^2)) %>%
# plot
ggplot(aes(x = x, y = covariance)) +
geom_line(aes(group = .draw),
linewidth = 1/4, alpha = 1/4, color = "#EEDA9D") +
stat_function(fun = function(x) mean(post$sdgp_a_gplat_adjlon2_adj)^2 *
exp(-(1 / (2 * mean(post$lscale_a_gplat_adjlon2_adj)^2)) * x^2),
color = "#DCA258", linewidth = 1) +
scale_x_continuous("distance (thousand km)", expand = c(0, 0),
breaks = 0:5 * 2) +
coord_cartesian(xlim = c(0, 10),
ylim = c(0, 2)) +
labs(subtitle = "Gaussian process posterior")
post %>%
slice_sample(n = 50) %>%
expand_grid(x = seq(from = 0, to = 10, by = .05)) %>%
mutate(covariance = etasq * exp(-rhosq * x^2))
post %>%
slice_sample(n = 50) %>%
expand_grid(x = seq(from = 0, to = 10, by = .05)) %>%
mutate(covariance = etasq * exp(-rhosq * x^2)) %>% View()
d1 = d1 %>%
mutate(vaccines = ifelse( vaccines > 7, NA, vaccines))
m1 <- brm(
data = d1,
family = cumulative,
bf( vaccines ~ a,
a ~ 1 + gp(age, scale = F),
nl = TRUE),
prior = c(
#prior(normal(0,1), class=a),
prior(inv_gamma(3, 3), class=lscale, coef=gpage, nlpar=a)),
iter=2000, warmup=1000, seed=3, cores=4
)
post %>%
slice_sample(n = 50) %>%
expand_grid(x = seq(from = 0, to = 10, by = .05)) %>%
mutate(covariance = etasq * exp(-rhosq * x^2)) %>%
# plot
ggplot(aes(x = x, y = covariance)) +
geom_line(aes(group = .draw),
linewidth = 1/4, alpha = 1/4, color = "#EEDA9D") +
stat_function(fun = function(x) mean(post$sdgp_a_gplat_adjlon2_adj)^2 *
exp(-(1 / (2 * mean(post$lscale_a_gplat_adjlon2_adj)^2)) * x^2),
color = "#DCA258", linewidth = 1) +
scale_x_continuous("distance (thousand km)", expand = c(0, 0),
breaks = 0:5 * 2) +
labs(subtitle = "Gaussian process posterior")
post %>%
slice_sample(n = 50) %>%
expand_grid(x = seq(from = 0, to = 10, by = .05)) %>%
mutate(covariance = etasq * exp(-rhosq * x^2)) %>%
# plot
ggplot(aes(x = x, y = covariance)) +
geom_line(aes(group = .draw),
linewidth = 1/4, alpha = 1/4) +
stat_function(fun = function(x) mean(post$sdgp_a_gplat_adjlon2_adj)^2 *
exp(-(1 / (2 * mean(post$lscale_a_gplat_adjlon2_adj)^2)) * x^2),
color = "#DCA258", linewidth = 1) +
scale_x_continuous("distance (thousand km)", expand = c(0, 0),
breaks = 0:5 * 2) +
labs(subtitle = "Gaussian process posterior")
library(tidyverse)
library(brms)
library(tidybayes)
library(bayesplot)
library(dagitty)
dag3 <- dagitty( "dag{ edu -> response; age -> response; edu -> age }" )
coordinates(dag3) <- list( x=c( edu=-1, age=1, response= 0) ,
y=c( edu=0, age=0, response= -1) )
rethinking::drawdag( dag3, cex = 1, lwd = 3 )
d <- data(Trolley, package = "rethinking")
d <- data(Trolley, package = "rethinking")
d <- Trolley
names(d)
# set up ordered categories for education
d <-
d %>%
mutate(edu_new =
recode(edu,
"Elementary School" = 1,
"Middle School" = 2,
"Some High School" = 3,
"High School Graduate" = 4,
"Some College" = 5,
"Bachelor's Degree" = 6,
"Master's Degree" = 7,
"Graduate Degree" = 8) %>%
as.integer())
m_total <- brm(
data = trolley,
family = cumulative,
response ~ 1 + mo(edu_new),
prior = c( prior(normal(0, 1.5), class = Intercept),
prior(normal(0, 0.143), class = b, coef = moedu_new),
prior(dirichlet(2, 2, 2, 2, 2, 2, 2), class = simo, coef = moedu_new1)),
iter=2000, warmup=1000, cores=4, chains=4,
file=here("files/models/hw6.1")
)
library(here)
m_total <- brm(
data = trolley,
family = cumulative,
response ~ 1 + mo(edu_new),
prior = c( prior(normal(0, 1.5), class = Intercept),
prior(normal(0, 0.143), class = b, coef = moedu_new),
prior(dirichlet(2, 2, 2, 2, 2, 2, 2), class = simo, coef = moedu_new1)),
iter=2000, warmup=1000, cores=4, chains=4,
file=here("files/models/hw6.1")
)
data(Trolley, package = "rethinking")
d <- Trolley
# set up ordered categories for education
d <-
d %>%
mutate(edu_new =
recode(edu,
"Elementary School" = 1,
"Middle School" = 2,
"Some High School" = 3,
"High School Graduate" = 4,
"Some College" = 5,
"Bachelor's Degree" = 6,
"Master's Degree" = 7,
"Graduate Degree" = 8) %>%
as.integer())
m_total <- brm(
data = d,
family = cumulative,
response ~ 1 + mo(edu_new),
prior = c( prior(normal(0, 1.5), class = Intercept),
prior(normal(0, 0.143), class = b, coef = moedu_new),
prior(dirichlet(2, 2, 2, 2, 2, 2, 2), class = simo, coef = moedu_new1)),
iter=2000, warmup=1000, cores=4, chains=4,
file=here("files/models/hw6.1")
)
m_total
# estimate direct effect of education
m_direct <- brm(
data = d,
family = cumulative,
response ~ 1 + age + mo(edu_new),
prior = c( prior(normal(0, 1.5), class = Intercept),
prior(normal(0, 1), class=b),
prior(normal(0, 0.143), class = b, coef = moedu_new),
prior(dirichlet(2, 2, 2, 2, 2, 2, 2), class = simo, coef = moedu_new1)),
iter=2000, warmup=1000, cores=4, chains=4,
file=here("files/models/hw6.2")
)
mcmc_rank_overlay(m_total)
mcmc_rank_overlay(m_total, facet_args = list(scales = "free"))
mcmc_rank_overlay(m_direct, facet_args = list(scales = "free"))
m_direct
post_total = as_draws_df(m_total)
names(post_total)
post_total = gather_draws(m_total, `.*moedu.*`, regex = T)
post_total
post_total =  gather_draws(m_total,  `.*moedu.*`, regex = T) %>% mutate(model="total")
post_direct = gather_draws(m_direct, `.*moedu.*`, regex = T) %>% mutate(model="direct")
full_join(post_total, post_direct)
full_join(post_total, post_direct) %>%
ggplot(aes(x = .value, y=model, fill = model)) +
stat_halfeye() +
facet_wrap(~.variable)
full_join(post_total, post_direct) %>%
ggplot(aes(x = .value, y=model, fill = model)) +
stat_halfeye() +
facet_wrap(~.variable, scales = "free")
full_join(post_total, post_direct) %>%
ggplot(aes(x = .value, y=model, fill = model)) +
stat_halfeye() +
facet_wrap(~.variable, scales = "free") +
guides(fill="none")
library(here)
library(tidyverse)
library(brms)
library(tidybayes)
library(bayesplot)
library(dagitty)
library(cowplot)
theme_set(theme_cowplot())
default_palettes <- list(
c("#5e8485" , "#0f393a") ,
c("#1c5253" , "#5e8485" , "#0f393a") ,
# palette with 5 colours
c( "#1c5253" , "#e07a5f", "#f2cc8f" , "#81b29a" , "#3d405b" ) ,
# same palette interpolated to 8 colours
c( "#1c5253" , "#e07a5f", "#f2cc8f" , "#81b29a" , "#3d405b" , "#a7a844" , "#69306d" )
)
options(ggplot2.discrete.fill = default_palettes,
ggplot2.discrete.colour = default_palettes)
full_join(post_total, post_direct) %>%
ggplot(aes(x = .value, y=model, fill = model)) +
stat_halfeye() +
facet_wrap(~.variable, scales = "free") +
guides(fill="none")
gather_draws(m_total,  `.*moedu.*`, regex = T) %>% mutate(model="total")
nd = d %>% distinct(edu_new)
nd = d %>% distinct(edu_new) %>%
mutate(age = 50)
ppd_total = nd %>% add_predicted_draws(m_total)
ppd_direct = nd %>% add_predicted_draws(m_direct)
ppd_direct
epred_total  = nd %>% add_epred_draws(m_total)
epred_direct = nd %>% add_epred_draws(m_direct)
View(epred_direct)
epred_total  = nd %>% add_epred_draws(m_total) %>% mutate(model="total")
epred_direct = nd %>% add_epred_draws(m_direct) %>% mutate(model="direct")
full_join(epred_total, epred_direct)
epred_total  = nd %>% add_epred_draws(m_total) %>%
mean_qi() %>%
mutate(model="total")
epred_total
nd = d %>% distinct(edu_new) %>%
mutate(age = 50)
epred_total  = nd %>% add_epred_draws(m_total) %>%
mean_qi() %>%
mutate(model="total")
epred_direct = nd %>% add_epred_draws(m_direct) %>%
mean_qi() %>%
mutate(model="direct")
full_join(epred_total, epred_direct)
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=model)) +
geom_point() +
geom_line() +
facet_wrap(~edu_new)
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=model)) +
geom_point() +
geom_line(aes(group=1)) +
facet_wrap(~edu_new)
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=model)) +
geom_point() +
geom_line(aes(group=model)) +
facet_wrap(~edu_new)
full_join(epred_total, epred_direct) %>%
#mutate(edu_new = )
ggplot(aes(x=.category, y =.epred, color=edu_new)) +
geom_point() +
geom_line(aes(group=edu_new)) +
facet_wrap(~model)
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=edu_new)) +
geom_point() +
geom_line(aes(group=edu_new)) +
facet_wrap(~model)
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=edu_new)) +
geom_point() +
geom_line(aes(group=edu_new)) +
facet_wrap(~model) +
guides(color = "none")
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=edu_new)) +
geom_point() +
geom_line(aes(group=edu_new)) +
facet_wrap(~model)
full_join(post_total, post_direct) %>%
ggplot(aes(x = .value, y=model, fill = model)) +
stat_halfeye() +
facet_wrap(~.variable, scales = "free") +
guides(fill="none")
full_join(epred_total, epred_direct) %>%
ggplot(aes(x=.category, y =.epred, color=edu_new)) +
geom_point() +
geom_line(aes(group=edu_new)) +
facet_wrap(~model)
