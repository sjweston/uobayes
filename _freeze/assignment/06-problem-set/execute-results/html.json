{
  "hash": "0b969247914ab2fef27f625b1075884d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Problem set 6\"\ndate: \"2025-05-12\"\n---\n\n\n\n\n\n\n## Instructions\n\nPlease use an RMarkdown file to complete this assignment. Make sure you reserve code chunks for code and write out any interpretations or explainations outside of code chunks. Submit the knitted PDF file containing your code and written answers on Canvas. \n\n## Questions\n\nIn the trolley data —`data(Trolley)`— we saw how education level (modeled as an ordered category) is associated with responses. But is this association causal? One plausible confound is that education is also associated with age, through a causal process: People are older when they finish school than when they begin it. Reconsider the Trolley data in this light. Draw a DAG that represents hypothetical causal relationships among response, education, and age. Which statistical model or models do you need to evaluate the causal influence of education on responses? Fit these models to the trolley data. What do you conclude about the causal relationships among these three variables?\n\n<details>\n<summary>Click to see the answer</summary>\n\nPackages used and default settings: \n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at /Users/sweston2/Library/CloudStorage/GoogleDrive-weston.sara@gmail.com/My Drive/Work (google drive)/teaching/uobayes\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(brms)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: Rcpp\nLoading 'brms' package (version 2.22.0). Useful instructions\ncan be found by typing help('brms'). A more detailed introduction\nto the package is available through vignette('brms_overview').\n\nAttaching package: 'brms'\n\nThe following object is masked from 'package:stats':\n\n    ar\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(tidybayes)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tidybayes'\n\nThe following objects are masked from 'package:brms':\n\n    dstudent_t, pstudent_t, qstudent_t, rstudent_t\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(bayesplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThis is bayesplot version 1.11.1.9000\n- Online documentation and vignettes at mc-stan.org/bayesplot\n- bayesplot theme set to bayesplot::theme_default()\n   * Does _not_ affect other ggplot2 plots\n   * See ?bayesplot_theme_set for details on theme setting\n\nAttaching package: 'bayesplot'\n\nThe following object is masked from 'package:brms':\n\n    rhat\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(dagitty)\nlibrary(cowplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'cowplot'\n\nThe following object is masked from 'package:lubridate':\n\n    stamp\n```\n\n\n:::\n\n```{.r .cell-code}\ntheme_set(theme_cowplot())\ndefault_palettes <- list(\n  c(\"#5e8485\" , \"#0f393a\") ,\n  c(\"#1c5253\" , \"#5e8485\" , \"#0f393a\") , \n  # palette with 5 colours\n c( \"#1c5253\" , \"#e07a5f\", \"#f2cc8f\" , \"#81b29a\" , \"#3d405b\" ) ,\n  # same palette interpolated to 8 colours\n c( \"#1c5253\" , \"#e07a5f\", \"#f2cc8f\" , \"#81b29a\" , \"#3d405b\" , \"#a7a844\" , \"#69306d\" ) \n  \n)\n\noptions(ggplot2.discrete.fill = default_palettes, \n        ggplot2.discrete.colour = default_palettes)\n```\n:::\n\n\n\n\nHere's my DAG. Yours may differ. I think both education and age cause someone's response. I also think education causes age: if I make someone get additional education, they will be older at the end of their training. On the other hand, if I were to make someone older, they wouldn't necessarily be more educated because of it.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndag3 <- dagitty( \"dag{ edu -> response; age -> response; edu -> age }\" )\ncoordinates(dag3) <- list( x=c( edu=-1, age=1, response= 0) , \n                           y=c( edu=0, age=0, response= -1) )\nrethinking::drawdag( dag3, cex = 1, lwd = 3 )\n```\n\n::: {.cell-output-display}\n![](06-problem-set_files/figure-html/unnamed-chunk-2-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\nBased on this, a model with only education would help me estimate the **TOTAL** effect of education on response. But if I want to estimate the **DIRECT** effect, I need to control for age.  I'll fit both models now. \n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndata(Trolley, package = \"rethinking\")\nd <- Trolley\n\n# set up ordered categories for education\nd <-\n  d %>% \n  mutate(edu_new = \n           recode(edu,\n                  \"Elementary School\" = 1,\n                  \"Middle School\" = 2,\n                  \"Some High School\" = 3,\n                  \"High School Graduate\" = 4,\n                  \"Some College\" = 5, \n                  \"Bachelor's Degree\" = 6,\n                  \"Master's Degree\" = 7,\n                  \"Graduate Degree\" = 8) %>% \n           as.integer())\n\n\n# estimate total effect of education\nm_total <- brm(\n  data = d,\n  family = cumulative, \n  response ~ 1 + mo(edu_new), \n  prior = c( prior(normal(0, 1.5), class = Intercept),\n             prior(normal(0, 0.143), class = b, coef = moedu_new), \n             prior(dirichlet(2, 2, 2, 2, 2, 2, 2), class = simo, coef = moedu_new1)),\n  iter=2000, warmup=1000, cores=4, chains=4,\n  file=here(\"files/models/hw6.1\")\n)\n\n# estimate direct effect of education\nm_direct <- brm(\n  data = d,\n  family = cumulative, \n  response ~ 1 + age + mo(edu_new), \n  prior = c( prior(normal(0, 1.5), class = Intercept),\n             prior(normal(0, 1), class=b),\n             prior(normal(0, 0.143), class = b, coef = moedu_new), \n             prior(dirichlet(2, 2, 2, 2, 2, 2, 2), class = simo, coef = moedu_new1)),\n  iter=2000, warmup=1000, cores=4, chains=4,\n  file=here(\"files/models/hw6.2\")\n)\n```\n:::\n\n\n\n\nI'm going to check that my chains have mixed using the trace rank plots.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmcmc_rank_overlay(m_total,  facet_args = list(scales = \"free\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_path()`: Each group consists of only one observation.\nℹ Do you need to adjust the group aesthetic?\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-problem-set_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=672}\n:::\n\n```{.r .cell-code}\nmcmc_rank_overlay(m_direct, facet_args = list(scales = \"free\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_path()`: Each group consists of only one observation.\nℹ Do you need to adjust the group aesthetic?\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-problem-set_files/figure-html/unnamed-chunk-4-2.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\n`m_total` looks good. I don't love what's happening with `m_direct` at the beginning, so perhaps I should have used more iterations with a longer warmup period. \n\nLet's compare the coefficient estimates for education on these models.\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npost_total =  gather_draws(m_total,  `.*moedu.*`, regex = T) %>% mutate(model=\"total\")\npost_direct = gather_draws(m_direct, `.*moedu.*`, regex = T) %>% mutate(model=\"direct\")\n\nfull_join(post_total, post_direct) %>% \n  ggplot(aes(x = .value, y=model, fill = model)) +\n  stat_halfeye() +\n  facet_wrap(~.variable, scales = \"free\") +\n  guides(fill=\"none\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(.chain, .iteration, .draw, .variable, .value,\nmodel)`\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-problem-set_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\nThere are a few interesting things happening here. The main thing is that the coefficent called `bsp_moedu_new` is larger in the direct effect model than in the total effect. As a reminder, this is the coefficient on $\\phi$ called $\\beta_E$:\n\n$$\n\\phi_i = \\beta_E\\sum_{j=0}^{E_i-1} \\delta_j\n$$\n\nThis value moves from a negative value in the total model to a small, possibly positive value in the direct model. This suggests that, after controlling for age, education makes participants more likely to give a higher response (or say that the scenarios are acceptable). But it's hard to know exactly what's happening. Instead, let's plot our posterior predictive models to see if we can make more sense of this. I'm going to grab the distinct values of education. I need to also select an age variable, but I don't want to cross these with education. Remember, it won't make sense to have a 12-year-old with a graduate degree. (I hope). I'm going to select a single age that would be appropriate for all education levels. (Let's say 50). \n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nnd = d %>% distinct(edu_new) %>% \n  mutate(age = 50)\n\nepred_total  = nd %>% add_epred_draws(m_total) %>% \n  mean_qi() %>% \n  mutate(model=\"total\")\nepred_direct = nd %>% add_epred_draws(m_direct) %>% \n  mean_qi() %>% \n  mutate(model=\"direct\")\n\nfull_join(epred_total, epred_direct) %>% \n  ggplot(aes(x=.category, y =.epred, color=edu_new)) +\n  geom_point() +\n  geom_line(aes(group=edu_new)) +\n  facet_wrap(~model)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nJoining with `by = join_by(edu_new, age, .row, .category, .epred, .lower,\n.upper, .width, .point, .interval, model)`\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](06-problem-set_files/figure-html/unnamed-chunk-6-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n\nWe've learned two things from this plot. \n\nThe main finding is that the effect of education is mainly through age. We see greater differentiation of education responses in the total model, but the response trends are more similar after stratifying on age. Again, our coefficient estimate went from large (mean around -.50) to small (mean around .2).\n\nWe also see the direction of the education effect is reversed. In the total plot, our less educated participants were more likely to choose 7, but in the direct plot, the less educated participatns are least likely to choose 7. This effect looks pretty small though. \n\n</details>\n",
    "supporting": [
      "06-problem-set_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}