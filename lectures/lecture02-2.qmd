---
title: "Week 2: Linear models and causal inference"
subtitle: "Categories and curves"
format: 
  revealjs:
    css: xaringan-themer2.css
    nature:
      highlightStyle: solarized-dark
      highlightLines: true
      countIncrementalSlides: false
      mathjax: "default"
    self-contained: false  # Ensures correct embedding
    embed-resources: true  # Embeds required assets
    slide-number: true
execute:
  echo: false  
---

Workspace setup:

```{r, results='hide', message = F, warning = F}
library(tidyverse)
library(cowplot)
library(rethinking)
library(patchwork)
```

```{r, echo = F}
knitr::opts_chunk$set(fig.retina=3, echo=TRUE)
theme_set(theme_cowplot())
default_palettes <- list(
  c("#5e8485" , "#0f393a") ,
  c("#1c5253" , "#5e8485" , "#0f393a") , 
  # palette with 5 colours
 c( "#1c5253" , "#e07a5f", "#f2cc8f" , "#81b29a" , "#3d405b" ) ,
  # same palette interpolated to 8 colours
 c( "#1c5253" , "#e07a5f", "#f2cc8f" , "#81b29a" , "#3d405b" , "#a7a844" , "#69306d" ) 
  
)

options(ggplot2.discrete.fill = default_palettes, 
        ggplot2.discrete.colour = default_palettes)
```


As we develop more useful models, we'll begin to practice the art of generating models with multiple estimands. An *estimand* is a quantity we want to estimate from the data. Our models may not themselves produce the answer to our central question, so we need to know how to calculate these values from the posterior distributions.

---

## Categories

Forget dummy codes. From here on out, we will incorporate categorical causes into our models by using index variables. An **index variable** contains integers that correspond to different categories. The numbers have no inherent meaning -- rather, they stand as placeholders or shorthand for categories. 

```{r}
data("Howell1")
d <- Howell1
d$sex <- ifelse(d$male == 1, 2, 1) # 1 = female, 2 = male
head(d[, c("male", "sex")])
```

---

### Mathematical model

Let's write a mathematical model to express height in terms of sex. 

\begin{align*}
h_i &\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &=     \alpha_{SEX[i]} \\
\alpha_j &\sim \text{Normal}(178, 20)\text{ for }j = 1..2 \\
\sigma &\sim \text{Uniform}(0, 50)
\end{align*}

```{r}
flist <- alist(
  height ~ dnorm( mu , sigma) ,
  mu <- a[sex] ,
  a[sex] ~ dnorm( 178, 20 ) ,
  sigma ~ dunif(0, 50)
)
```


---

### Fitting the model using `quap()`

```{r}
m1 <- quap(
  flist, data=d
)

precis(m1, depth=2)
```

Here, we are given the estimates of the parameters specified in our model: the average height of women (`a[1]`) and the average height of men (`a[2]`).  But our question is whether these average heights are different. How do we get that?

---

```{r}
post <- extract.samples( m1 )
str(post)
head(post$a)
post$diff_fm <- post$a[,1] - post$a[,2]
precis(post, depth=2 )
```

---

We can create two plots. One is the posterior distributions of average female and male heights and one is the average difference. 

```{r post-sex, eval = F}

p1 <- post %>% as.data.frame() %>% 
  pivot_longer(starts_with("a")) %>% 
  mutate(sex = ifelse(name == "a.1", "female", "male")) %>% 
  ggplot(aes(x=value, color = sex)) +
  geom_density(linewidth = 2) +
  labs(x = "height(cm)") 

p2 <- post %>% as.data.frame() %>% 
  ggplot(aes(x=diff_fm)) +
  geom_density(linewidth = 2) +
  labs(x = "difference in height(cm)") 

( p1 | p2)
```

---

```{r ref.label="post-sex", fig.height=5, fig.width=8,  fig.align="center", echo =F}

```



---

A note that the distributions of the _mean_ heights is not the same as the distribution of heights period. For that, we need the posterior predictive distributions. 

```{r post-sex2, eval = F}

pred_f  <- rnorm(1e4, mean = post$a[,1], sd = post$sigma )
pred_m  <- rnorm(1e4, mean = post$a[,2], sd = post$sigma )

pred_post = data.frame(pred_f, pred_m) %>%
  mutate(diff = pred_f-pred_m)

# plot distributions
p1 <- pred_post %>% pivot_longer(starts_with("pred")) %>% 
  mutate(sex = ifelse(name == "pred_f", "female", "male")) %>% 
  ggplot(aes(x = value, color = sex)) +
  geom_density(linewidth = 2) +
  labs(x = "height (cm)")

# plot difference
# Compute density first
density_data <- density(pred_post$diff)

# Convert to a tibble for plotting
density_df <- tibble(
  x = density_data$x,
  y = density_data$y,
  fill_group = ifelse(x < 0, "male", "female")  # Define fill condition
)

# Plot with area fill
p2 <- ggplot(density_df, aes(x = x, y = y, fill = fill_group)) +
  geom_area() +  # Adjust transparency if needed
  geom_line(linewidth = 1.2, color = "black") +  # Keep one continuous curve
  labs(x = "Difference in height (F-M)", y = "density") +
  guides(fill = "none")

(p1 | p2)
```

---

```{r ref.label="post-sex2", fig.height=5, fig.width=8, fig.align = "center", ,echo =F}

```


---

## Exercise

In the `rethinking` package, the dataset `milk` contains information about the composition of milk across primate species, as well as some other facts about those species. The taxonomic membership of each species is included in the variable `clade`; there are four categories.

  1. Create variable in the dataset to assign an index value to each of the 4 categories. 
  2. Standardize the milk energy variable (`kcal.per.g`). [^1]
  3. Write a mathematical model to express the average milk energy (in standardized kilocalories) in each clade. 

[^1]: You don't need to be an expert in primate biology to have a sense of what is reasonable for these values after we standardize.


---

```{r}
data("milk")
str(milk)
milk$clade_id <- as.integer(milk$clade)
milk$K <- standardize(milk$kcal.per.g)
```


\begin{align*}
K_i &\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha_{\text{CLAUDE}[i]} \\
\alpha_i &\sim \text{Normal}(0, 0.5) \text{ for }j=1..4 \\
\sigma &\sim \text{Exponential}(1) \\
\end{align*}


**Exercise:** Now fit your model using `quap()`. It's ok if your mathematical model is a bit different from mine.

---

```{r}
flist <- alist(
  K ~ dnorm( mu , sigma ) ,
  mu <- a[clade_id] , 
  a[clade_id] ~ dnorm( 0 , 0.5 ) , 
  sigma ~ dexp( 1 )
)

m2 <- quap(
  flist, data = milk
)

precis( m2, depth=2 )
```


---

### Plotting with `rethinking`

```{r, fig.height=5, fig.width=8}
labels <- paste( "a[" , 1:4, "]:", levels(milk$clade),  sep="" )
plot(
  precis(m2, depth=2, pars = "a"),
  labels=labels, 
  xlab="expected kcal (std)"
)
```

---

### Exercise

Plot the following distributions:

 * Posterior distribution of average milk energy by clade. 
 * Posterior distribution of predicted milk energy values by clade. 
 
---

```{r}
post <- extract.samples( m2 )
names(labels) = paste("a.", 1:4, sep = "")
post %>% as.data.frame() %>% 
  pivot_longer(starts_with("a")) %>% 
  mutate(name = recode(name, !!!labels)) %>% 
  ggplot(aes(x = value, color = name)) +
  geom_density(linewidth = 2)
```

---

```{r}
post <- extract.samples( m2 )
a.1 = rnorm(1e4, post$a[,1], post$sigma)
a.2 = rnorm(1e4, post$a[,2], post$sigma)
a.3 = rnorm(1e4, post$a[,3], post$sigma)
a.4 = rnorm(1e4, post$a[,4], post$sigma)
data.frame(a.1, a.2, a.3, a.4) %>% 
  pivot_longer(everything()) %>% 
  mutate(name = recode(name, !!!labels)) %>% 
  ggplot(aes(x = value, color = name)) +
  geom_density(linewidth = 2)
```



